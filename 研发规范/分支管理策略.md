# 分支管理策略

版本控制系统是指对软件开发过程中程序代码、配置文件、文档等发生的变更进行管理的系统，它可以帮助团队更好的沟通协作，从而更好的进行交付，常见的版本控制系统分为集中式版本控制系统（如SVN）和分布式版本控制系统（如Git）

由于git天生的管理方式是通过各种分支进行协作和归一，分支策略使用混乱时，往往就体现为研发代码的混乱，比如有这么一个团队：最初开发团队从主干分支拉出一条特性分支，但新功能完成后，该特性分支没有合入主干分支，而是作为下次开发的主干分支，重新拉出一条新的特性分支，导致主干分支一直形同虚设，团队没有一条稳定的代码分支。于是整个产品就呈现出一种极不稳定的状态。因此，**制定一个如何使用分支的规范就显得尤为重要**。

## 常见的分支策略

在使用Git时，你可以指定各种不同的分支管理策略和工作流程，在面对复杂项目时，使用结构化的工作流程就尤为重要，通过合理的分支策略，你可以得到：

- 代码管理和组织：通过分支策略，你可以清晰的知道每个分支的作用，以及尽可能避免工作重叠(比如当别人在维护一个`feature-新增`时，你就知道你不需要为这个特性再进行编写了);同时可以保证所有参与者都向着同一个目标在前进
- 版本控制：可以保证不同feature能同时进行，互不干扰，保证代码的稳定
- 可回溯、可追责：有利于更清晰得看到代码的提交历史，以及作者；方便更快捷得定位到责任人进行指派
- 更快的交接和跟进：如果团队有新人入职，可以通过不同的分支进度，很快了解到目前团队的进程，更高效得进行投入
- 更明确的时间和资源管理：通过代码的合并和提交情况，可以很清晰的看到各个feature的进度，以及团队的工作量，从而更好的进行时间和资源的管理
- CI/CD: 有利于更好的接入自动化测试和部署，形成更好得 release 周期，比如可以更好得管理执行的时机，和稳定的部署方式和分支，从而保障交付的稳定性。比如通过规定 master 分支只能通过 CI/CD 进行部署，每次测试完的代码只能合并进入 master ，这样只有测试完的release才能进入生产环境，从而保证了生产环境的稳定性

常见的分支策略有：

- Centralized workflow：集中式的够工作流，即所有人都在main/master分支上进行操作，这时候其实git已经成为了一个实际意义的svn，这种方式适用于小团队，或者是对代码管理要求不高的团队
- Feature branch workflow：基于 feature 的工作流，开发人员为每个 feature 及 bugfix 创建分支，只需要保持 master 稳定； 当一个 feature 开发测试完成后，开发提交一个MR请求，并在完成代码审计后合入 master
- Forking workflow：基于仓库fork的工作流，一般开源项目使用较多，不同的开发者通过fork从主仓库中复制一个仓库，然后在这个仓库上进行操作，开发完成后，通过提交一个合并请求来将变更推送至主仓库
- Git-flow workflow：Git flow工作流，这个模式最适合有稳定release迭代的项目，这个模式下有两个需要一直维护的分支，即 main/master 和 develop 分支，除这两个 long-lived 的分支外，还定义了 feature, release, 和 hotfix 这些分支，用于实现和保障开发过程
- GitLab/GitHub flow：结合了 Feature branch 和 Git flow workflow 的工作流，开发人员直接从 main/master 拉 feature，开发测试完成后，将代码合并回 main/master 

## Git-flow

GitFlow通常包含五种类型的分支：master分支、develop分支、feature分支、release分支以及hotfix分支。

 - master 分支：**主干**分支，也是正式发布版本的分支，其包含可以部署到生产环境中的代码，通常情况下只允许其他分支将代码合入，**不允许master分支直接提交代码**（对应生产环境）。
 - develop 分支：**开发**分支，用来集成测试最新合入的开发成果，包含要发布到下一个 release 的代码（对应开发环境）
 - feature 分支: **特性**分支，通常从 develop 分支拉出，每个新特性的开发对应一个特性分支，用于开发人员提交代码并进行自测。自测完成后，会将 feature 分支的代码合并至 develop 分支，进入下一个 release (严格意义上讲，其实 develop 也是不能直接提交的)
 - release 分支：**发布**分支，发布新版本时，基于 develop 分支创建，发布完成后，合并到 master 和 develop 分支（对应集成测试环境）
 - hotfix 分支：热修复分支，生产环境发现新bug时创建的临时分支，问题验证通过后，合并到 master 和 develop 分支

 ![git-flow.png](https://nvie.com/img/git-model@2x.png)

 基于以上，Git-flow中的分支名称以及一些合并、拉取，提交以及是否需要删除的限制条件为：
 
  - master：
    - 拉取：不需要拉取，是项目的主干分支
    - 合并：只允许来自 release-*、hotfix-*的 合并
    - 提交：不允许直接提交
    - 删除：不允许删除
  - develop
    - 拉取：项目开始时从 master 拉取，且只能从 master 拉取
    - 合并：只允许来自 feature-*、release-*、hotfix-* 的合并
    - 提交：严格要求时是不允许直接提交的，但实践中大部分团队都是允许直接提交的
    - 删除：不允许删除
  - feature-*（有的团队可能使用feat-*的格式）：
    - 拉取：只能从 develop 拉取
    - 合并：只能合并回 develop
    - 提交：可直接提交，是频繁变动的分支
    - 删除：完成后需要删除
  - release-*：
    - 拉取：只能从 develop 拉取，拉取的时间节点是预先定义好的 release 内容全部开发完成并合并回了 develop
    - 合并：**只能且必须**合并回 master 和 develop
    - 提交：看具体情况，有的团队允许直接提交，有的团队不允许直接提交(不允许直接提交的一般是从 release 拉取 bugfix-* 分支，然后在 bugfix-* 分支上进行 bugfix，bugfix 完成后合并回 release 分支，然后再合并回 develop 分支)
    - 删除：完成后需要删除
  - hotfix-*:
    - 拉取：只能从 master 拉取，master环境发现bug后，需要紧急修复的时候，从 master 拉取 hotfix-* 分支
    - 合并：**必须**合并回 master 和 develop
    - 提交：可直接提交
    - 删除：完成后需要删除


